#!/bin/bash

# æ™ºèƒ½ Git æäº¤è„šæœ¬ - ä¸ºä»»ä½• Overleaf é¡¹ç›®ç”Ÿæˆ commit message
# ä½¿ç”¨æ–¹æ³•: åœ¨é¡¹ç›®ç›®å½•ä¸­è¿è¡Œ overleaf-commit

PROJECT_DIR="${1:-.}"
cd "$PROJECT_DIR" || exit 1

# æ£€æŸ¥æ˜¯å¦æ˜¯ git ä»“åº“
if [[ ! -d .git ]]; then
    echo "âŒ é”™è¯¯: å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
if [[ -z $(git status -s) ]]; then
    echo "âœ“ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
    exit 0
fi

echo "ğŸ” åˆ†ææ›´æ”¹ä¸­..."
echo ""

# æ·»åŠ æ‰€æœ‰æ›´æ”¹
git add .

# è·å–æ›´æ”¹æ‘˜è¦
CHANGES=$(git diff --cached --stat)
DETAILED=$(git diff --cached --name-status)

echo "å‘ç°ä»¥ä¸‹æ›´æ”¹ï¼š"
echo "$CHANGES"
echo ""

# æ™ºèƒ½ç”Ÿæˆ message
NEW_FILES=$(echo "$DETAILED" | grep "^A" | wc -l | tr -d ' ')
MODIFIED_FILES=$(echo "$DETAILED" | grep "^M" | wc -l | tr -d ' ')
DELETED_FILES=$(echo "$DETAILED" | grep "^D" | wc -l | tr -d ' ')

MESSAGE=""
TIMESTAMP=$(date "+%Y-%m-%d %H:%M")

if [ $NEW_FILES -gt 0 ]; then
    FILES=$(echo "$DETAILED" | grep "^A" | sed 's/^A\t//' | xargs -I {} basename {} | head -3 | tr '\n' ', ' | sed 's/, $//')
    if [ $NEW_FILES -gt 3 ]; then
        MESSAGE="${MESSAGE}æ–°å¢ ${NEW_FILES} ä¸ªæ–‡ä»¶ (${FILES}...); "
    else
        MESSAGE="${MESSAGE}æ–°å¢ ${FILES}; "
    fi
fi

if [ $MODIFIED_FILES -gt 0 ]; then
    FILES=$(echo "$DETAILED" | grep "^M" | sed 's/^M\t//' | xargs -I {} basename {} | head -3 | tr '\n' ', ' | sed 's/, $//')
    if [ $MODIFIED_FILES -gt 3 ]; then
        MESSAGE="${MESSAGE}ä¿®æ”¹ ${MODIFIED_FILES} ä¸ªæ–‡ä»¶ (${FILES}...); "
    else
        MESSAGE="${MESSAGE}ä¿®æ”¹ ${FILES}; "
    fi
fi

if [ $DELETED_FILES -gt 0 ]; then
    FILES=$(echo "$DETAILED" | grep "^D" | sed 's/^D\t//' | xargs -I {} basename {} | head -3 | tr '\n' ', ' | sed 's/, $//')
    MESSAGE="${MESSAGE}åˆ é™¤ ${FILES}"
fi

MESSAGE="[${TIMESTAMP}] ${MESSAGE}"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "å»ºè®®çš„ commit message:"
echo "$MESSAGE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
read -p "æŒ‰ Enter ä½¿ç”¨å»ºè®®ï¼Œæˆ–è¾“å…¥è‡ªå®šä¹‰ message: " CUSTOM_MSG

FINAL_MSG="${CUSTOM_MSG:-$MESSAGE}"

# æäº¤
git commit -m "$FINAL_MSG"
echo ""
echo "âœ“ å·²æäº¤åˆ°æœ¬åœ° Git"
echo ""

# æ£€æŸ¥æ˜¯å¦æœ‰ overleaf remote
if git remote | grep -q "^overleaf$"; then
    read -p "æ˜¯å¦æ¨é€åˆ° Overleaf? (y/n): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "ğŸ“¤ æ¨é€åˆ° Overleaf..."
        git push overleaf master
        echo "âœ“ æ¨é€æˆåŠŸï¼"
    else
        echo "â¸ï¸  å·²è·³è¿‡æ¨é€"
    fi
else
    echo "â„¹ï¸  æ²¡æœ‰é…ç½® Overleaf remoteï¼Œåªæäº¤åˆ°æœ¬åœ°"
fi
