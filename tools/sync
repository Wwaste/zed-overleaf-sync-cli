#!/bin/bash

# ä» Overleaf åŒæ­¥è„šæœ¬ - ä¸‹è½½æœ€æ–°å†…å®¹

PROJECT_DIR="${1:-.}"
cd "$PROJECT_DIR" || exit 1

# æ£€æŸ¥æ˜¯å¦æœ‰ .overleaf-meta.json
if [[ ! -f .overleaf-meta.json ]]; then
    echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° .overleaf-meta.json"
    echo "è¿™ä¸æ˜¯ä¸€ä¸ª Overleaf é¡¹ç›®ç›®å½•"
    exit 1
fi

# è¯»å–é¡¹ç›®ä¿¡æ¯
PROJECT_ID=$(grep -o '"projectId": "[^"]*"' .overleaf-meta.json | cut -d'"' -f4)
USE_GIT=$(grep -o '"useGit": *[^,}]*' .overleaf-meta.json | grep -o 'true')

echo "ğŸ”„ ä» Overleaf åŒæ­¥é¡¹ç›®..."
echo "Project ID: $PROJECT_ID"
echo ""

# å¦‚æœé…ç½®äº† Gitï¼Œä¼˜å…ˆä½¿ç”¨ Git åŒæ­¥
if [[ -n "$USE_GIT" ]] && [[ -d .git ]] && git remote | grep -q "^overleaf$"; then
    echo "ğŸ“¥ ä½¿ç”¨ Git åŒæ­¥..."
    git pull overleaf master
    if [[ $? -eq 0 ]]; then
        echo ""
        echo "âœ“ Git åŒæ­¥å®Œæˆï¼"
        exit 0
    else
        echo ""
        echo "âš ï¸  Git åŒæ­¥å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¸‹è½½..."
        echo ""
    fi
fi

# ä½¿ç”¨ç›´æ¥ä¸‹è½½ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
COOKIE=$(grep -o '"cookie": "[^"]*"' ~/.overleaf-zed/config.json 2>/dev/null | cut -d'"' -f4)

if [[ -z "$COOKIE" ]]; then
    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ç™»å½•ä¿¡æ¯"
    echo "è¯·å…ˆè¿è¡Œ: overleaf-cli login"
    exit 1
fi

# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
TMP_ZIP="/tmp/overleaf-sync-$$.zip"
curl -L "https://www.overleaf.com/project/$PROJECT_ID/download/zip" \
  -H "Cookie: $COOKIE" \
  -o "$TMP_ZIP" 2>/dev/null

if [[ ! -f "$TMP_ZIP" ]]; then
    echo "âŒ ä¸‹è½½å¤±è´¥"
    exit 1
fi

# è§£å‹åˆ°ä¸´æ—¶ç›®å½•
TMP_DIR="/tmp/overleaf-temp-$$"
mkdir -p "$TMP_DIR"
unzip -q "$TMP_ZIP" -d "$TMP_DIR"

# åŒæ­¥æ–‡ä»¶ï¼ˆä¿ç•™ .git å’Œå·¥å…·è„šæœ¬ï¼‰
rsync -av --delete --exclude='.git' --exclude='.overleaf-meta.json' \
  --exclude='commit' --exclude='sync' \
  "$TMP_DIR/" ./

# æ¸…ç†
rm -rf "$TMP_DIR" "$TMP_ZIP"

echo ""
echo "âœ“ åŒæ­¥å®Œæˆï¼"
echo ""
echo "è¿è¡Œ 'git status' æŸ¥çœ‹æ›´æ”¹"
